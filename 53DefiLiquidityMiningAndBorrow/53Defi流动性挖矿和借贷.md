# 53 Defi流动性挖矿与借贷

# 流动性挖矿

这个词本身比较难以理解，我找到了一段话说明Stake > Farm > Mine的渐进关系

#### Stakeing

###### 比如POS需要你拿32个ETH才可以做验证者

“质押”这个词是什么意思?像“拿你的名誉去做赌注”或“什么处于危险之中”这样的术语和短语意味着因为你为某事担保而拿自己冒险。因此，当用户相信一个项目的基本原理时，他们会愿意持有自己的货币/代币，并将其锁定更长时间。老用户持有的资产数量向新买家展示了对项目的信心，新买家的购买增加了老用户的投资组合价值。

#### Yield Farming

###### 比如Uniswap你提供两种代币放到一个池子里，种瓜得瓜种豆得豆，0.3%/次的手续费给你也是这两种代币

农民在地里播种，等待有利可图的产品的产量。他们不断轮换土地，根据季节和最佳生产力和回报种植不同的种子。农民也是这样做的，根据不断变化的条件，寻找最佳选择，轮作土地/平台以获得最佳回报。他们投入时间并获得回报。

#### Liquidity Mining

###### 比如Sushiswap你提供两种代币放池子，除了按0.2%/次的手续费得两种代币，还有0.1%/次的价值直接转换成Sushi代币归你，是你“挖”出来的，每天都可以拿走，不用等你撤掉池子

挖矿需要努力挖掘新的和以前没有使用过的东西。当流动性矿工通过锁定另一项资产提供流动性时，他们将获得平台代币的奖励。例如，CrossFi为Filecoin (FIL)持有者提供收益，并根据他们投入代币的时间用平台代币CRFI奖励他们。CrossFi是少数几个允许按需解除质押的平台之一，这意味着你甚至可以在第二天取回你的Filecoin，而不是强制性的长时间。

# SushiSwap（Farm+Mine）

有时候也会把stake说成是一个farm的一个环节，因为用户提供了两种代币之后得到的LP币就相当于stake在池子里面了

sushi代币每个区块会有100个被Mint生成，用来奖励所有的LP拥有者们，但是因为奖励要每个区块都写进各个LP拥有者们的地址，难道要每个区块都遍历来保存每个拥有者实际得到了多少Sushi吗？

#### 挖矿算法

显然不需要每一个块都计算一次，只需要记住你的份额，这个份额进来的时间点，然后就可以在你退出的时候给你结算，保证你的timeDelta * share跟别人的timeDelta * share是公平等分所有奖励的

# 借贷

需要资金，但是不想卖掉资产，可以选择超额抵押，意思是抵押品的价值必须大于接借出的价值

## Compound

> compound：复合，复利
>
> 复利这个词很好地解释了借贷的意义，这里的利息都是利滚利的

### 服务简单概括

- 存款人：存入资产如USDC，赚USDC计价的利息
- 借款人：抵押资产如ETH，借出资产如USDC，付USDC计价的利息
  - 借什么就付什么计价的利息，不是说都用USDC来计价利息

### 利率模型

##### 一、资金利用率（Utilization Rate）

- U = Total Borrow / (Total Cash + Total Borrows - Reserves)

- 利用率 = 总借出 / (总位借出现金 + 总借出 + 储备金)

> 比如总存入1000U，已经借出800U，预留20U不可借出
>
> U = 800 / (1000 - 20) = 81.6 %

##### 二、年化借款利率（Borrow Rate）

if U <= kink : 

- Borrow Rate = baseRate + U * mutiplier
- 借款利率 = 基本利率 + 资金使用率 * 低因子

if U > kink :

- Borrow Rate = baseRate + kink * multiplier + (U-kink) * jumpMutiplier
- 借款利率 = 基本利率 + (折点 * 低因子) + (超出使用率 * 高因子)

> 1. kink：折点，你看到的利率飙升的那个临界点，比如80%
> 2. baseRate：基本利率，比如一般的是5%
> 3. multiplier/jumpMutiplier：因子或者叫乘子，分高和低，比如低是0.2，高是1.5
>
> 比如0.8是折点，基本利率5%，低高因子：0.2和1.5
>
> 那么使用率低时候 BR = 5% + 0.2 * U 
>
> 使用率大于0.8时候  BR = 5% + (0.2 * 0.8) + (e * 1.5) = 6.6% + 1.5e

##### 三、年化存款利率（Supply Rate）

- Supply Rate = Borrow Rate * U * (1 - resverFactor)
- 存款利率 = 借款利率 * 资金使用率 * (1 - 存款准备金率)

> 比如准备金率是10%，那么存款1000里其实有900是可以外借的
>
> 当U达到折点临界的时候比如0.8
>
> SR = (5% + 0.2 * 0.8) * 0.8 * (1 - 0.1) = 6.6% * 0.72 = 4.752 % 

### 计算利息

利率都是实时的，存款人存入（Supply）赎回（Redeem）；借款人借出（Borrow）还款（Repay）都会更新资金录用率，进而影响BR和SR

那么如何计算存款人的存款利息收入和借款人的利息支出呢？

##### 一、借款利息

每一块都重新计息并加入欠款金额，然后下一块再根据利率计息再加入欠款金额

##### 二、存款利息

需要用到cToken，表示存票，比如存入ETH得到cETH，存入USDC得cUSDC，一开始cUSDC:USDC = 1, 随着区块增加， cUSDC:USDC > 1，实际情况可能一开始不是1而是100，然后增长到105

### APR与APY

APR（Annual Percentage Rate）年化利率表示当前的日利率 * 365天得到的一年的收益比例

APY（Annual Percentage Yield）年化收益率表示当前的利率，如果接下来一年每一块都这个利率，每块帮你把上一块的利息放入本金计算利息（块滚利）的话得到的一年收益比例

### 预言机和清算

在借款人的那个部分中，协议会获取chainlink的DataFeed来获取实际的各个资产的对ETH的价格（ETH本位），借款人**抵押总价值/借出总价值**必须>120%，否则会触发清算

代码中也常用**抵押率**（collateral factor）的概念，就是**借出总价值/抵押总价值**，不同的抵押物可能会有不同的抵押率，越不稳定的抵押物资产的抵押率压的越低，越低抵押率对于借款人和协议来说是越安全的

如果抵押物的资产价格下跌，那么就会变成可清算的状态，为了鼓励套利者做清算，会将抵押物做一点折扣，比如你帮某个合约偿还100U价值的借出物，会得到108U价值的抵押物

## 金库 Vault（ERC4626）

是包装和标准化“存入资产” -> "获得收益"的金库的接口，就像前面提到的存款人存入（Supply）赎回（Redeem）；借款人借出（Borrow）还款（Repay）

本身继承ERC20，得到的token像前面说的cToken一样作为**存票**的含义