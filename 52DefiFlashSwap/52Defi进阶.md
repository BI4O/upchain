# 52 Defi进阶

# WETH

> https://etherscan.io/token/0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2#code

因为在uniswapV2中，是ERC20token的两两建池子，所以把eth也写成了一个erc20，叫做warpped-ETH，简称WETH

- deposit()

- withdraw()

有点像之前的tokenBank一样，不过这个抵押的是真的ETH，然后得到WETH，然后通过调用回收，也能收到自己之前抵押的ETH

# 无常损失

表示流动性提供者，在提供一对代币（比如ETH-USDT）进池子之后，经过一段时间池子去交易之后，无论是ETH本位还是U本位，看起来总额都减少的现象。

> #####  为什么叫“无常”？
>
> 因为这种损失**只有在你取出资金的时候才真正实现（即变为“永久”）**。如果价格最终回到原点（ETH 回到 你提供时候的 U价格），你就没有损失。**所以叫“无常”（Impermanent）**

##### ✅ LP 赚钱的典型场景：

| 场景                                                        | 原因                                               |
| ----------------------------------------------------------- | -------------------------------------------------- |
| ✅ 稳定币交易对（如 USDC/DAI）                               | 价格波动小，无常损失几乎为零，但仍有交易手续费可赚 |
| ✅ 横盘震荡的币种（例如 ETH/USDT 来回在 2000-2100 之间震荡） | 无常损失小，但交易频繁，手续费收益高               |
| ✅ 手续费率高（如 SushiSwap 有些池子 0.3%）+ 交易量高        | 高频交易可以累积可观手续费覆盖损失                 |
| ✅ LP 激励（如流动性挖矿、奖励代币）                         | 额外的收益来源让总收益为正                         |
| ✅ 对冲无常损失的策略（如对冲工具、Delta neutral）           | 高阶玩家会用其他方式抵消风险                       |

##### ❌ LP 亏钱的典型场景：

| 场景                                            | 原因                                              |
| ----------------------------------------------- | ------------------------------------------------- |
| ❌ 单边大幅上涨的资产（如 ETH 从 $1000 → $3000） | ETH 会被套利卖出，你持有的 ETH 减少，错过上涨收益 |
| ❌ 单边下跌资产                                  | 你会收到更多跌价的资产，价值减少                  |
| ❌ 冷门交易对、交易量低                          | 没有多少手续费可赚，亏损更明显                    |
| ❌ 没有额外激励、短期内取出资金                  | 无法依靠时间积累手续费覆盖损失                    |

# 闪电兑/贷

不同地方的说法不一样，其实flashSwap和flashloan都是说的一回事，我觉得叫flashSwap比较贴切，因为是闪电，所以其实你根本就没有抵押或过什么

| 项目               | 闪电兑换（Flash Swap）     | 闪电贷（Flash Loan）       |
| ------------------ | -------------------------- | -------------------------- |
| 平台               | Uniswap V2 特有            | Aave、Balancer、DyDx 等    |
| 借出对象           | 池子里的任意 Token         | 只借出资产（一般是主流币） |
| 是否需要还等值资产 | ✅ 是（回收时校验）         | ✅ 是                       |
| 编程难度           | 中                         | 中~高                      |
| 用途               | 套利、清算、抛售、高级策略 | 同样                       |

#### 示例

1. 发现**Uniswap**上1900一颗ETH，而**SushiSwap**2000一颗
2. 存在100/1900 = 5.26%价差，减去0.3%手续费，也还有将近4%
3. 从 **Uniswap** 通过 Flash Swap 借出 `100 ETH`
4. 在 **SushiSwap** 以 `2000 DAI` 卖出 → 获得 `200,000 DAI`
5. 归还给 Uniswap：
   - 借款成本：`100 ETH × 1900 = 190,000 DAI`
   - 手续费（0.3%）：`190,000 × 0.003 = 570 DAI`
   - 总还款：`190,570 DAI`

> 例子：https://github.com/xilibi2003/v2-periphery/blob/master/contracts/FlashSwap.sol

# 时间加权平均价TWAP

> time weighted average price，TWAP

就像区块链的出块机制一样，每一次价格更新都可以看作是基于**前一个时间点的价格累积状态（price cumulative root）**进行的“价格快照”。

------

### 🔁 Swap 与累计价格的更新机制

在 **Uniswap V2 的 Core 模块中**，每次调用 `swap()` 时，都会发生两件重要的事情：

1. **更新储备量**：池子中两个代币的余额会被更新。
2. **刷新累计价格**（`price0CumulativeLast` 和 `price1CumulativeLast`）：
   - 累计价格 = 上次累计值 + 当前价格 × 时间间隔（秒）

```
新的累计价 = 上一次累计价 + （当前价格 × 距离上次更新的时间间隔）
```

> 注意：这个“当前价格”是以池子中两个代币的储备比例计算的瞬时价格，并不等于 TWAP。

------

### 🕰️ 为什么使用累计价格计算 TWAP？

Uniswap V2 设计了一个巧妙的 TWAP 预言机，依赖的是 `priceCumulativeLast` 这样的**累计价格值**。这样做的好处是：

- 🧮 **计算简单**：TWAP = (累积价格差值) ÷ (时间间隔)
- 🔒 **抗操纵性强**：单次波动对 TWAP 的影响有限，必须长时间控制价格才能改变 TWAP
- 📉 **价格更平滑**：相比实时价格，TWAP 波动更小，适合前端展示或合约参考

### 🔁 这个 `_update()` 会在以下三个地方自动被调用：

1. **`swap()`**：有人发起交易，触发更新
2. **`mint()`**：有人添加流动性，触发更新
3. **`burn()`**：有人移除流动性，触发更新

------

### 🧭 TWAP 更新策略

你不需要每一秒都刷新价格，反而应控制更新间隔：

- ⏱️ 比如每 **60 秒** 更新一次，就可以避免过于频繁的波动
- 🪄 这样做在 Dapp 前端页面上，展示的价格就会更**平稳可靠**

# UniSwapV3

Uniswap V3 针对 V2 存在的资金利用率低的问题，提出了更高效的做市机制。

### 🧩 V2 的问题：资金利用率低

- 在 Uniswap V2 中，所有流动性都平均分布在整个价格范围（0 到 ∞）上。
- 实际交易却往往集中在某一小段价格区域，导致大量流动性处于“闲置状态”。

### 💡 V3 的解决方案：**集中式流动性（Concentrated Liquidity）**

- 允许 LP（流动性提供者）自定义资金在哪个价格区间内提供流动性。
- 这些价格区间被称为 **价格刻度（ticks）**。
- 合约内部引入了**虚拟流动性（virtual liquidity）**的概念，来高效管理这些分段流动性。

### ✅ 优势

- 🏦 **资金利用率大幅提升**：相同资金下可实现更高的深度。
- 📈 **收益更高**：资金集中在常用价格区间，手续费收入增加。
- ⚙️ **更灵活的做市策略**：LP 可以按风险偏好选择价格区间。

> 总结：Uniswap V3 通过引入“集中式流动性”机制，让 LP 只在某一价格范围内提供资金，提升了整体资金利用率与收益效率。

# UniswapV4

Uniswap V4 引入了更强大的**可定制性和扩展性**，核心改进是引入了「Hooks」机制，让开发者能打造自己的 AMM 模型。

### 🧩 V3 的限制

- 虽然 V3 引入了集中流动性，但池子逻辑仍然固定，无法扩展。
- 每种新功能（如动态费用、自动再投资）都需要部署一个新的合约版本或外部逻辑，碎片化严重。

------

### 💡 V4 的解决方案：**Hooks + 单合约架构**

#### ✅ Hooks：像插件一样插入自定义逻辑

- **Hook** 是一个用户定义的合约，可在池子生命周期的关键点运行：
  - 添加流动性前后
  - 交易前后
  - 提现前后等
- 例如，可以实现：
  - 动态费率
  - 自动化做市策略
  - MEV 保护
  - 限价单、TWAMM 等新功能

#### ✅ Singleton 合约：降低 gas 成本

- 所有池子都挂在同一个合约里，节省部署和调用成本。
- 存储由 `CREATE2` 管理，避免重复部署逻辑代码。

> 总结：Uniswap V4 通过引入 Hook 插件机制与单合约架构，让 AMM 从“产品”变成一个可编程平台，赋予开发者前所未有的自由度。

# UniswapX（聚合器Router）

> UniswapX 是 Uniswap 推出的**链上交易聚合协议**，通过引入「第三方填单者（Fillers）」来提升用户交易效率，并解决跨链、流动性碎片化等问题。

------

### 🧩 背景：V2/V3/V4 是 AMM，UniswapX 是 DEX Aggregator

- V2/V3/V4 聚焦在做市机制（AMM）设计；
- 而 UniswapX 更像是一个 **交易协议层**，帮助用户**从多个流动性来源获取最优价格**；
- 它不一定和自己的池子成交，也可以通过第三方或其他 DEX 路由交易。

------

### 💡 核心机制：**Intent-based Trading（意图驱动交易）**

- 用户发出交易意图（如：我想用 100 USDC 换最多的 ETH）；
- 第三方「**Filler**」监听并填单，用自己预先准备好的路径和资金完成撮合；
- 交易最终在链上结算，确保透明、安全、可验证。

------

### ✅ 特性

- 🔄 **聚合流动性**：可从 Uniswap、其他 DEX，甚至 CEX 获取最优报价；
- 🌉 **跨链支持**：未来支持多链交易意图聚合；
- 🧾 **无手续费滑点**：用户只需提供“我想达成的目标”，由 Filler 负责如何达成；
- 🧠 **支持 Gasless 交易**：Filler 可代付 Gas，用户签名意图即可；
- ⚡ **可与 Uniswap Hooks 联动**：未来可结合 V4 定制策略。

> 总结：UniswapX 是 Uniswap 推出的意图驱动交易协议，让用户交易无需关心路径和池子，由第三方 Filler 竞价填单，获得更优价格和体验。

# Curve （稳定币DEX）

> Curve 是一个专注于 **稳定币/锚定资产交易** 的去中心化交易所（DEX），以**低滑点、高效率**著称。

------

### 🎯 核心目标

- 优化**稳定币与锚定资产（如 stETH、frxETH 等）之间的兑换效率**
- 减少滑点和无常损失，提升资金利用率

------

### 🧪 核心机制：**StableSwap 曲线算法**

- 与 Uniswap 的 x*y=k 不同，Curve 使用一种更平滑的函数曲线
- **特点**：
  - 在资产价格接近时（如 USDC 与 USDT），提供极低滑点
  - 在资产偏离锚定价时，滑点迅速增大，保护池子稳定性

------

### 🔧 Curve v2（CryptoSwap）

- 支持非锚定资产（如 ETH 与 WBTC）
- 引入链上波动率估计，根据实际市场情况**动态调整算法曲线**

------

### 💰 veCRV 机制（治理+激励）

- LP 通过锁仓 CRV 代币获得 veCRV，参与治理并决定奖励分配
- 形成了“**投票买票**”生态，引发了著名的「Curve Wars」

------

### ✅ 优势总结

| 优势           | 说明                                   |
| -------------- | -------------------------------------- |
| 🏦 极低滑点     | 特别适合稳定币之间的大额交易           |
| 💸 收益优化     | 多池子整合 + 外部协议整合（如 Convex） |
| 🧠 自适应模型   | v2 动态定价 + 聚合器机制支持更多资产   |
| 🗳️ 去中心化治理 | 通过 veCRV 和 Gauge 机制分配激励与权力 |

> 总结：Curve 是专为稳定资产设计的 DEX，以稳定、高效著称，并通过 veCRV 机制形成了强大的治理和生态飞轮效应。